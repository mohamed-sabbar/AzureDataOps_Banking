trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: variable group  # Votre groupe de variables Azure DevOps
  - name: DATABRICKS_HOST
    value: 'https://adb-1119135389290183.3.azuredatabricks.net'
  - name: DATABRICKS_WORKSPACE_PATH
    value: '/Workspace/Users/mohamedazrou2003@gmail.com'
  - name: DATABRICKS_JOB_ID
    value: '89'

steps:
  # =============================================
  # 1. Installer Python
  # =============================================
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.10'
    displayName: 'ğŸ Installer Python 3.10'
  
  # =============================================
  # 2. Installer dÃ©pendances
  # =============================================
  - script: |
      echo "ğŸ“¦ Installation des dÃ©pendances..."
      pip install --upgrade pip
      
      # Installer requirements.txt si existe
      if [ -f "requirements.txt" ]; then
        pip install -r requirements.txt
        echo "âœ… requirements.txt installÃ©"
      else
        echo "â„¹ï¸ Aucun requirements.txt trouvÃ©"
      fi
      
      # Installer Databricks CLI
      pip install databricks-cli
      echo "âœ… Databricks CLI installÃ©"
      databricks --version
    displayName: 'ğŸ“¦ Installer dÃ©pendances'
  
  # =============================================
  # 3. Installer jq (pour parser JSON)
  # =============================================
  - script: |
      sudo apt-get update -qq
      sudo apt-get install -y jq
      jq --version
    displayName: 'ğŸ”§ Installer jq'
  
  # =============================================
  # 4. Configurer Databricks CLI (CORRIGÃ‰)
  # =============================================
  - script: |
      echo "ğŸ” Configuration Databricks CLI..."
      
      # CrÃ©er le dossier de configuration
      mkdir -p ~/.databricks
      
      # CrÃ©er le fichier de configuration
      cat > ~/.databrickscfg <<EOF
      [DEFAULT]
      host = $(DATABRICKS_HOST)
      token = $(DATABRICKS_TOKEN)
      EOF
      
      echo "âœ… Fichier de configuration crÃ©Ã©"
      
      # Tester la connexion
      echo "ğŸ”Œ Test de connexion..."
      databricks workspace ls / > /dev/null 2>&1
      
      if [ $? -eq 0 ]; then
        echo "âœ… Connexion Databricks rÃ©ussie !"
      else
        echo "âŒ ERREUR : Impossible de se connecter Ã  Databricks"
        echo "VÃ©rifiez DATABRICKS_HOST et DATABRICKS_TOKEN"
        exit 1
      fi
    displayName: 'ğŸ” Configurer Databricks CLI'
  
  # =============================================
  # 5. VÃ©rifier structure du projet
  # =============================================
  - script: |
      echo "ğŸ“‚ Structure du projet :"
      ls -la
      
      echo ""
      echo "ğŸ“ Contenu de notebooks/ :"
      if [ -d "notebooks" ]; then
        ls -la notebooks/
        
        # Compter les fichiers
        file_count=$(find notebooks -type f \( -name "*.py" -o -name "*.ipynb" \) | wc -l)
        echo ""
        echo "ğŸ“Š Nombre de notebooks trouvÃ©s : $file_count"
        
        if [ $file_count -eq 0 ]; then
          echo "âš ï¸ ATTENTION : Aucun notebook trouvÃ© dans le dossier notebooks/"
          exit 1
        fi
      else
        echo "âŒ ERREUR : Le dossier notebooks/ n'existe pas"
        exit 1
      fi
    displayName: 'ğŸ” VÃ©rifier structure du projet'
  
  # =============================================
  # 6. DÃ©ployer les notebooks (AMÃ‰LIORÃ‰)
  # =============================================
  - script: |
      echo "ğŸ“¤ DÃ©ploiement des notebooks vers Databricks..."
      echo "ğŸ¯ Destination : $(DATABRICKS_WORKSPACE_PATH)"
      
      # CrÃ©er le dossier de destination si nÃ©cessaire
      echo "ğŸ“‚ CrÃ©ation du rÃ©pertoire workspace..."
      databricks workspace mkdirs $(DATABRICKS_WORKSPACE_PATH) 2>/dev/null || echo "RÃ©pertoire dÃ©jÃ  existant"
      
      # DÃ©ployer tous les notebooks
      echo "ğŸ“¥ Import des notebooks..."
      databricks workspace import_dir notebooks $(DATABRICKS_WORKSPACE_PATH) --overwrite
      
      if [ $? -eq 0 ]; then
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "   âœ… DÃ‰PLOIEMENT RÃ‰USSI"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“‹ Notebooks dÃ©ployÃ©s :"
        databricks workspace ls -l $(DATABRICKS_WORKSPACE_PATH)
        echo ""
        echo "ğŸ”— AccÃ¨s workspace :"
        echo "   $(DATABRICKS_HOST)/#workspace$(DATABRICKS_WORKSPACE_PATH)"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      else
        echo "âŒ ERREUR lors du dÃ©ploiement des notebooks"
        exit 1
      fi
    displayName: 'ğŸ“¤ DÃ©ployer notebooks Databricks'
  
  # =============================================
  # 7. ExÃ©cuter le job Databricks (CORRIGÃ‰)
  # =============================================
  - script: |
      echo "ğŸš€ Lancement du job Databricks..."
      echo "ğŸ¯ Job ID : $(DATABRICKS_JOB_ID)"
      
      # Lancer le job et capturer la rÃ©ponse
      response=$(databricks jobs run-now --job-id $(DATABRICKS_JOB_ID) 2>&1)
      
      echo "ğŸ“¨ RÃ©ponse du serveur :"
      echo "$response"
      
      # Extraire le run_id
      run_id=$(echo "$response" | jq -r '.run_id // empty' 2>/dev/null)
      
      if [ -z "$run_id" ] || [ "$run_id" == "null" ]; then
        echo ""
        echo "âŒ ERREUR : Impossible de lancer le job"
        echo "ğŸ“‹ VÃ©rifiez que :"
        echo "   â€¢ Le job ID $(DATABRICKS_JOB_ID) existe"
        echo "   â€¢ Le job a une configuration valide"
        echo "   â€¢ Votre token a les permissions nÃ©cessaires"
        echo ""
        echo "RÃ©ponse complÃ¨te : $response"
        exit 1
      fi
      
      echo ""
      echo "âœ… Job lancÃ© avec succÃ¨s !"
      echo "â–¶ï¸  Run ID : $run_id"
      echo "ğŸ”— Suivi : $(DATABRICKS_HOST)/#job/$(DATABRICKS_JOB_ID)/run/$run_id"
      echo ""
      
      # Sauvegarder le run_id pour l'Ã©tape suivante
      echo "##vso[task.setvariable variable=RUN_ID]$run_id"
    displayName: 'ğŸš€ Lancer job Databricks'
  
  # =============================================
  # 8. Attendre et vÃ©rifier le rÃ©sultat (NOUVEAU)
  # =============================================
  - script: |
      echo "â³ Attente de la fin de l'exÃ©cution du job..."
      echo "ğŸ“Š Run ID : $(RUN_ID)"
      
      # Attendre la fin du job (timeout 30 minutes)
      timeout 1800 databricks runs wait --run-id $(RUN_ID)
      wait_exit_code=$?
      
      echo ""
      
      if [ $wait_exit_code -eq 0 ]; then
        # Job terminÃ©, vÃ©rifier le statut
        echo "ğŸ” RÃ©cupÃ©ration du statut final..."
        run_details=$(databricks runs get --run-id $(RUN_ID))
        
        life_cycle_state=$(echo "$run_details" | jq -r '.state.life_cycle_state')
        result_state=$(echo "$run_details" | jq -r '.state.result_state')
        
        echo "ğŸ“Š Ã‰tat du cycle de vie : $life_cycle_state"
        echo "ğŸ“Š Ã‰tat du rÃ©sultat : $result_state"
        
        if [ "$result_state" == "SUCCESS" ]; then
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   âœ…âœ…âœ… JOB TERMINÃ‰ AVEC SUCCÃˆS âœ…âœ…âœ…"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š DÃ©tails :"
          echo "   â€¢ Job ID : $(DATABRICKS_JOB_ID)"
          echo "   â€¢ Run ID : $(RUN_ID)"
          echo "   â€¢ Ã‰tat : $result_state"
          echo ""
          echo "ğŸ”— Voir les dÃ©tails :"
          echo "   $(DATABRICKS_HOST)/#job/$(DATABRICKS_JOB_ID)/run/$(RUN_ID)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 0
        else
          echo ""
          echo "âŒ JOB Ã‰CHOUÃ‰ : $result_state"
          echo ""
          echo "ğŸ“‹ Logs d'erreur :"
          databricks runs get-output --run-id $(RUN_ID)
          echo ""
          echo "ğŸ”— Voir les dÃ©tails complets :"
          echo "   $(DATABRICKS_HOST)/#job/$(DATABRICKS_JOB_ID)/run/$(RUN_ID)"
          exit 1
        fi
      elif [ $wait_exit_code -eq 124 ]; then
        echo "â±ï¸ TIMEOUT : Le job a dÃ©passÃ© 30 minutes d'exÃ©cution"
        echo "ğŸ”— VÃ©rifier manuellement : $(DATABRICKS_HOST)/#job/$(DATABRICKS_JOB_ID)/run/$(RUN_ID)"
        exit 1
      else
        echo "âŒ Erreur lors de l'attente du job (code: $wait_exit_code)"
        exit 1
      fi
    displayName: 'â³ Attendre et vÃ©rifier rÃ©sultat'
  
  # =============================================
  # 9. RÃ©capitulatif final (toujours exÃ©cutÃ©)
  # =============================================
  - script: |
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "   ğŸ“Š RÃ‰CAPITULATIF DU DÃ‰PLOIEMENT"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "âœ… Ã‰tapes complÃ©tÃ©es :"
      echo "   â€¢ Configuration Databricks"
      echo "   â€¢ DÃ©ploiement des notebooks"
      echo "   â€¢ ExÃ©cution du job"
      echo ""
      echo "ğŸ”— Liens utiles :"
      echo "   â€¢ Workspace : $(DATABRICKS_HOST)/#workspace$(DATABRICKS_WORKSPACE_PATH)"
      echo "   â€¢ Job : $(DATABRICKS_HOST)/#job/$(DATABRICKS_JOB_ID)"
      echo ""
      echo "ğŸ“… Date : $(date '+%Y-%m-%d %H:%M:%S')"
      echo "ğŸ·ï¸  Build : $(Build.BuildNumber)"
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    displayName: 'ğŸ“Š RÃ©capitulatif final'
    condition: always()