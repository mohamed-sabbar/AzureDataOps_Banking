trigger:
  branches:
    include:
      - main
  paths:
    include:
      - notebooks/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: variable group
  - name: DATABRICKS_HOST
    value: 'https://adb-1119135389290183.3.azuredatabricks.net'
  - name: DATABRICKS_WORKSPACE_PATH
    value: '/Workspace/Users/mohamedazrou2003@gmail.com'
  - name: DATABRICKS_JOB_ID
    value: '89'   # Ton job Databricks

steps:
  ###############################################################
  # DEBUG REPO
  ###############################################################
  - script: |
      echo "ðŸ“‚ STRUCTURE DU REPOSITORY:"
      ls -R
      echo ""
      echo "ðŸ“ Contenu du dossier notebooks:"
      ls -la notebooks/ || echo "âŒ Le dossier notebooks n'existe pas!"
    displayName: 'ðŸ” DEBUG - Structure du repo'
  
  - script: |
      echo "ðŸ” COMMITS RÃ‰CENTS:"
      git log --oneline -5
      echo ""
      echo "ðŸ“ FICHIERS MODIFIÃ‰S:"
      git diff --name-only HEAD~1 HEAD || git ls-files
      echo ""
      echo "ðŸŽ¯ NOTEBOOKS MODIFIÃ‰S:"
      git diff --name-only HEAD~1 HEAD | grep "^notebooks/" || echo "Aucun notebook modifiÃ©"
    displayName: 'ðŸ” DEBUG - Changements dÃ©tectÃ©s'

  ###############################################################
  # PYTHON + DATABRICKS CLI
  ###############################################################
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.10'
    displayName: 'Installer Python 3.10'

  - script: |
      pip install -r requirements.txt || true
      pip install databricks-cli
    displayName: 'Installer dÃ©pendances'

  ###############################################################
  # CONFIGURATION DATABRICKS CLI (VERSION STABLE)
  ###############################################################
  - script: |
      echo "ðŸ”§ CrÃ©ation du fichier ~/.databrickscfg"
      mkdir -p ~/.databricks
      cat > ~/.databrickscfg <<EOF
      [DEFAULT]
      host = $(DATABRICKS_HOST)
      token = $(databricksToken)
      EOF

      echo "ðŸ“„ Contenu du fichier de config:"
      cat ~/.databrickscfg

      echo "ðŸ”Œ Test de connexion :"
      databricks workspace ls /
    displayName: 'Configurer Databricks CLI'

  ###############################################################
  # DEPLOIEMENT DES NOTEBOOKS
  ###############################################################
  - script: |
      echo "ðŸ“¤ DEPLOIEMENT DES NOTEBOOKS"
      echo "Source: $(Build.SourcesDirectory)/notebooks"
      echo "Destination: $(DATABRICKS_WORKSPACE_PATH)"
      echo ""

      if [ ! -d "notebooks" ]; then
        echo "âŒ ERREUR: Le dossier 'notebooks' n'existe pas!"
        exit 1
      fi

      echo "ðŸ“ Fichiers Ã  dÃ©ployer :"
      find notebooks -type f

      databricks workspace import_dir notebooks $(DATABRICKS_WORKSPACE_PATH) --overwrite

      if [ $? -eq 0 ]; then
        echo "âœ… DÃ©ploiement rÃ©ussi!"
        databricks workspace ls -l $(DATABRICKS_WORKSPACE_PATH)
      else
        echo "âŒ Ã‰chec du dÃ©ploiement"
        exit 1
      fi
    displayName: 'DÃ©ployer notebooks vers Databricks'

  ###############################################################
  # EXECUTION Dâ€™UN JOB DATABRICKS
  ###############################################################
  - script: sudo apt-get install -y jq
    displayName: 'Installer jq'

  - script: |
      echo "ðŸš€ ExÃ©cution du job Databricks ID=$(DATABRICKS_JOB_ID)"

      RESPONSE=$(databricks jobs run-now --job-id $(DATABRICKS_JOB_ID))
      echo "RÃ©ponse API:"
      echo "$RESPONSE"

      run_id=$(echo "$RESPONSE" | jq -r '.run_id')

      if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
        echo "âŒ ERREUR: Impossible de rÃ©cupÃ©rer run_id !"
        exit 1
      fi

      echo "â–¶ï¸ Run ID lancÃ© : $run_id"
      echo "â³ En attente de la fin du job..."

      databricks runs wait --run-id $run_id

      echo "âœ… Job Databricks terminÃ© avec succÃ¨s!"
    displayName: 'ðŸš€ ExÃ©cuter job Databricks aprÃ¨s dÃ©ploiement'
