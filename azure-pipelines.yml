trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: variable group
  - name: DATABRICKS_HOST
    value: 'https://adb-1119135389290183.3.azuredatabricks.net'
  - name: DATABRICKS_WORKSPACE_PATH
    value: '/Workspace/Users/mohamedazrou2003@gmail.com'
  - name: DATABRICKS_JOB_ID
    value: '88667285424105'   # Ton vrai job ID

steps:
# =============================================
# 1. Installer Python
# =============================================
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.10'
  displayName: 'ðŸ Installer Python 3.10'

# =============================================
# 2. Installer dÃ©pendances
# =============================================
- script: |
    echo "ðŸ“¦ Installation des dÃ©pendances..."
    pip install --upgrade pip
    pip install databricks-cli
    pip install jq
  displayName: 'ðŸ“¦ Installer dÃ©pendances'

# =============================================
# 3. Configurer Databricks CLI (API 2.1)
# =============================================
- script: |
    echo "ðŸ” Configurer Databricks CLI..."

    mkdir -p ~/.databricks

    cat > ~/.databrickscfg <<EOF
    [DEFAULT]
    host = $(DATABRICKS_HOST)
    token = $(DATABRICKS_TOKEN)
    EOF

    echo "âž¡ï¸ Configuration en API 2.1"
    databricks jobs configure --version=2.1

    echo "ðŸ”Œ Test de connexion"
    databricks workspace ls /
  displayName: 'ðŸ” Configurer Databricks CLI'

# =============================================
# 4. DÃ©ployer les notebooks
# =============================================
- script: |
    echo "ðŸ“¤ DÃ©ploiement des notebooks..."
    databricks workspace mkdirs $(DATABRICKS_WORKSPACE_PATH)
    databricks workspace import_dir notebooks $(DATABRICKS_WORKSPACE_PATH) --overwrite
  displayName: 'ðŸ“¤ DÃ©ployer notebooks Databricks'

# =============================================
# 5. Lancer le job (corrigÃ© + fiable)
# =============================================
- script: |
    echo "ðŸš€ Lancement du job Databricks..."
    echo "ðŸŽ¯ Job ID : $(DATABRICKS_JOB_ID)"

    # Lancer le job
    response=$(databricks jobs run-now --job-id $(DATABRICKS_JOB_ID))

    echo "ðŸ“¨ RÃ©ponse brute :"
    echo "$response"

    # Extraire proprement la ligne JSON
    json_line=$(echo "$response" | grep '{')

    # Extraire run_id
    run_id=$(echo "$json_line" | jq -r '.run_id')

    if [[ -z "$run_id" || "$run_id" == "null" ]]; then
      echo "âŒ ERREUR : Impossible dâ€™extraire run_id"
      echo "RÃ©ponse reÃ§ue : $response"
      exit 1
    fi

    echo "âœ… Job lancÃ© ! Run ID : $run_id"

    # Enregistrer variable pour l'Ã©tape suivante
    echo "##vso[task.setvariable variable=RUN_ID]$run_id"
  displayName: 'ðŸš€ Lancer job Databricks'

# =============================================
# 6. Attendre + vÃ©rifier le rÃ©sultat
# =============================================
- script: |
    echo "â³ Attente fin job..."
    echo "â–¶ï¸ Run ID : $(RUN_ID)"

    databricks runs wait --run-id $(RUN_ID)
    status=$?

    if [ $status -ne 0 ]; then
      echo "âŒ Le job a Ã©chouÃ© pendant lâ€™attente."
      exit 1
    fi

    details=$(databricks runs get --run-id $(RUN_ID))

    result=$(echo "$details" | jq -r '.state.result_state')

    echo "ðŸ“Š Resultat : $result"

    if [ "$result" != "SUCCESS" ]; then
      echo "âŒ Job Ã©chouÃ© â—"
      databricks runs get-output --run-id $(RUN_ID)
      exit 1
    fi

    echo "ðŸŽ‰ JOB TERMINÃ‰ AVEC SUCCÃˆS ðŸŽ‰"
  displayName: 'â³ Attendre et vÃ©rifier rÃ©sultat'

# =============================================
# 7. RÃ©capitulatif final
# =============================================
- script: |
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   ðŸ“Š FIN DU PIPELINE â€“ TOUT EST OK"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "Job : $(DATABRICKS_JOB_ID)"
    echo "Run : $(RUN_ID)"
    echo "Workspace : $(DATABRICKS_WORKSPACE_PATH)"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  displayName: 'ðŸ“Š RÃ©capitulatif final'
  condition: always()
