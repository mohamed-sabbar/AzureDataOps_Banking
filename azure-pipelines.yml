trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: variable group
  - name: DATABRICKS_HOST
    value: 'https://adb-2212117686739670.10.azuredatabricks.net'
  - name: DATABRICKS_JOB_ID
    value: '1082960958397714'

steps:
# =============================================
# 1. Installer Python et Databricks CLI
# =============================================
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.10'
  displayName: 'ðŸ Installer Python 3.10'

- script: |
    pip install --upgrade pip
    pip install databricks-cli jq
    echo "âœ… Databricks CLI et jq installÃ©s"
  displayName: 'ðŸ“¦ Installer dÃ©pendances'

# =============================================
# 2. Configurer Databricks CLI
# =============================================
- script: |
    mkdir -p ~/.databricks
    cat > ~/.databrickscfg <<EOF
    [DEFAULT]
    host = $(DATABRICKS_HOST)
    token = $(DATABRICKS_TOKEN)
    EOF
    echo "âœ… CLI Databricks configurÃ©e"
  displayName: 'ðŸ” Configurer Databricks CLI'

# =============================================
# 3. Lancer le job Databricks (avec PATH corrigÃ©)
# =============================================
- script: |
    # Ajouter le dossier des binaires Python locaux au PATH
    export PATH=$HOME/.local/bin:$PATH

    # VÃ©rifier que databricks CLI est accessible
    databricks --version

    JOB_ID=$(DATABRICKS_JOB_ID)
    run_id=$(databricks jobs run-now --job-id $JOB_ID | jq -r '.run_id')

    if [[ -z "$run_id" || "$run_id" == "null" ]]; then
      echo "âŒ Impossible d'extraire run_id"
      exit 1
    fi

    echo "âœ… Job lancÃ© ! Run ID : $run_id"
    echo "##vso[task.setvariable variable=RUN_ID]$run_id"
  displayName: 'ðŸš€ Lancer job Databricks'
