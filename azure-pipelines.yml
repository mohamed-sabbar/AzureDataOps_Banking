trigger:
  branches:
    include:
      - main
  paths:
    include:
      - notebooks/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: variable group
  - name: DATABRICKS_HOST
    value: 'https://adb-1119135389290183.3.azuredatabricks.net'
  - name: DATABRICKS_WORKSPACE_PATH
    value: '/Workspace/Users/mohamedazrou2003@gmail.com'
  - name: DATABRICKS_JOB_ID
    value: '811728064107146'  # ID de ton job Databricks

steps:
  # DEBUG: VÃ©rifier le contenu du repository
  - script: |
      echo "ðŸ“‚ STRUCTURE DU REPOSITORY:"
      ls -R
      echo ""
      echo "ðŸ“ Contenu du dossier notebooks:"
      ls -la notebooks/ || echo "âŒ Le dossier notebooks n'existe pas!"
    displayName: 'ðŸ” DEBUG - Structure du repo'
  
  # Installer Python
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.10'
    displayName: 'Installer Python 3.10'
  
  # Installer dÃ©pendances
  - script: |
      pip install -r requirements.txt
      pip install databricks-cli
    displayName: 'Installer dÃ©pendances'
  
  # Configurer Databricks CLI
  - script: |
      cat > ~/.databrickscfg <<EOF
      [DEFAULT]
      host = $(DATABRICKS_HOST)
      token = $(DATABRICKS_TOKEN)
      EOF

      echo "âœ… CLI Databricks configurÃ©e"
      
      # Tester la connexion
      echo "ðŸ”Œ TEST DE CONNEXION:"
      databricks workspace ls /Workspace/Users || echo "âŒ Connexion Ã©chouÃ©e"
    displayName: 'Configurer Databricks CLI'
  
  # DÃ©ployer TOUS les notebooks
  - script: |
      echo "ðŸ“¤ DÃ‰PLOIEMENT DE TOUS LES NOTEBOOKS"
      if [ ! -d "notebooks" ]; then
        echo "âŒ ERREUR: Le dossier 'notebooks' n'existe pas!"
        exit 1
      fi
      databricks workspace import_dir notebooks $(DATABRICKS_WORKSPACE_PATH) --overwrite
      echo "âœ… DÃ©ploiement terminÃ©"
    displayName: 'DÃ©ployer notebooks vers Databricks'

  # ExÃ©cuter le job Databricks
  - script: |
      sudo apt-get update && sudo apt-get install -y jq
      echo "ðŸš€ Lancement du Job Databricks ID=$(DATABRICKS_JOB_ID)"
      run_id=$(databricks jobs run-now --job-id $(DATABRICKS_JOB_ID) | jq -r '.run_id')
      if [ -z "$run_id" ]; then
        echo "âŒ ERREUR: Aucun run_id retournÃ©!"
        exit 1
      fi
      echo "â–¶ï¸ Run ID lancÃ© : $run_id"
      echo "â³ En attente de la fin du job..."
      databricks runs wait --run-id $run_id
      echo "âœ… Job Databricks terminÃ© avec succÃ¨s!"
    displayName: 'ðŸš€ ExÃ©cuter job Databricks aprÃ¨s dÃ©ploiement'
