trigger:
  branches:
    include:
      - main
  paths:
    include:
      - notebooks/**  # DÃ©clenche uniquement si des fichiers dans notebooks/ changent

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: variable group
  - name: DATABRICKS_HOST
    value: 'https://adb-1119135389290183.3.azuredatabricks.net'

steps:
  # Installer Python
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.10'
    displayName: 'Installer Python 3.10'
  
  # Installer dÃ©pendances
  - script: |
      pip install -r requirements.txt
      pip install databricks-cli
    displayName: 'Installer dÃ©pendances'
  
  # Configuration Databricks CLI
  - script: |
      echo "Configuration de Databricks CLI..."
      echo "$(DATABRICKS_HOST)" > ~/.databrickscfg_host
      echo "$(DATABRICKS_TOKEN)" > ~/.databrickscfg_token
      
      cat > ~/.databrickscfg <<EOF
      [DEFAULT]
      host = $(DATABRICKS_HOST)
      token = $(DATABRICKS_TOKEN)
      EOF
      
      echo "âœ… CLI Databricks configurÃ©e"
    displayName: 'Configurer Databricks CLI'
  
  # VÃ©rifier les fichiers modifiÃ©s
  - script: |
      echo "ðŸ“‚ Fichiers modifiÃ©s dans ce commit:"
      git diff --name-only HEAD~1 HEAD | grep "^notebooks/" || echo "Aucun notebook modifiÃ©"
    displayName: 'Afficher fichiers modifiÃ©s'
  
  # DÃ©ployer les notebooks dans Databricks
  - script: |
      echo "ðŸ“¤ DÃ©ploiement des notebooks..."
      databricks workspace import_dir notebooks /Workspace/Users/mohamedazrou2003@gmail.com --overwrite
      
      if [ $? -eq 0 ]; then
        echo "âœ… Notebooks importÃ©s avec succÃ¨s dans Databricks"
      else
        echo "âŒ Erreur lors de l'import des notebooks"
        exit 1
      fi
    displayName: 'DÃ©ployer notebooks Databricks'
  
  # Lister les notebooks dÃ©ployÃ©s
  - script: |
      echo "ðŸ“‹ Notebooks dÃ©ployÃ©s:"
      databricks workspace ls /Workspace/Users/mohamedazrou2003@gmail.com
    displayName: 'VÃ©rifier notebooks dÃ©ployÃ©s'
  
  # ExÃ©cuter le job Databricks
  - script: |
      echo "ðŸš€ Lancement du job Databricks (ID: 89)..."
      RUN_ID=$(databricks jobs run-now --job-id 89 | jq -r '.run_id')
      
      if [ -z "$RUN_ID" ]; then
        echo "âŒ Erreur: Impossible de lancer le job"
        exit 1
      fi
      
      echo "âœ… Job lancÃ© avec Run ID: $RUN_ID"
      echo "ðŸ”— Suivi: $(DATABRICKS_HOST)/#job/89/run/$RUN_ID"
      
      # Optionnel: Attendre la fin du job
      echo "â³ Attente de la fin du job..."
      while true; do
        STATE=$(databricks runs get --run-id $RUN_ID | jq -r '.state.life_cycle_state')
        echo "Ã‰tat actuel: $STATE"
        
        if [ "$STATE" = "TERMINATED" ] || [ "$STATE" = "SKIPPED" ] || [ "$STATE" = "INTERNAL_ERROR" ]; then
          RESULT=$(databricks runs get --run-id $RUN_ID | jq -r '.state.result_state')
          echo "RÃ©sultat final: $RESULT"
          
          if [ "$RESULT" = "SUCCESS" ]; then
            echo "âœ… Job terminÃ© avec succÃ¨s"
            exit 0
          else
            echo "âŒ Job Ã©chouÃ© avec Ã©tat: $RESULT"
            exit 1
          fi
        fi
        
        sleep 30
      done
    displayName: 'ExÃ©cuter job Databricks'