trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: variable group   # Contient DATABRICKS_TOKEN
  - name: DATABRICKS_HOST
    value: 'https://adb-1119135389290183.3.azuredatabricks.net'
  - name: DATABRICKS_JOB_ID
    value: '88667285424105'

steps:
# =============================================
# 1. Installer Python et Databricks SDK
# =============================================
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.10'
  displayName: 'ðŸ Installer Python 3.10'

- script: |
    pip install --upgrade pip
    pip install --upgrade databricks-sdk jq
  displayName: 'ðŸ“¦ Installer Databricks SDK'

# =============================================
# 2. Configurer Databricks CLI
# =============================================
- script: |
    mkdir -p ~/.databricks
    cat > ~/.databrickscfg <<EOF
    [DEFAULT]
    host = $(DATABRICKS_HOST)
    token = $(DATABRICKS_TOKEN)
    EOF
    echo "âœ… CLI Databricks configurÃ©e"
  displayName: 'ðŸ” Configurer Databricks CLI'

# =============================================
# 3. Lancer le job Databricks
# =============================================
- script: |
    JOB_ID=$(DATABRICKS_JOB_ID)
    run_id=$(databricks jobs run-now --job-id $JOB_ID | jq -r '.run_id')
    
    if [[ -z "$run_id" || "$run_id" == "null" ]]; then
      echo "âŒ Impossible d'extraire run_id"
      exit 1
    fi

    echo "âœ… Job lancÃ© ! Run ID : $run_id"
    echo "##vso[task.setvariable variable=RUN_ID]$run_id"
  displayName: 'ðŸš€ Lancer job Databricks'
