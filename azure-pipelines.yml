trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: variable group
  - name: DATABRICKS_HOST
    value: 'https://adb-1119135389290183.3.azuredatabricks.net'
  - name: DATABRICKS_WORKSPACE_PATH
    value: '/Workspace/Users/mohamedazrou2003@gmail.com'
  - name: DATABRICKS_JOB_ID
    value: '88667285424105'   # Ton vrai Job ID

# =============================================
# 1. Installer Python et dÃ©pendances
# =============================================
steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.10'
  displayName: 'ðŸ Installer Python 3.10'

- script: |
    echo "ðŸ“¦ Installation des dÃ©pendances..."
    pip install --upgrade pip
    pip install databricks-cli jq
  displayName: 'ðŸ“¦ Installer dÃ©pendances'

# =============================================
# 2. Configurer Databricks CLI (API 2.1)
# =============================================
- script: |
    echo "ðŸ” Configurer Databricks CLI..."
    mkdir -p ~/.databricks

    cat > ~/.databrickscfg <<EOF
    [DEFAULT]
    host = $(DATABRICKS_HOST)
    token = $(DATABRICKS_TOKEN)
    EOF

    echo "âž¡ï¸ Passer en Jobs API 2.1"
    databricks jobs configure --version=2.1

    echo "ðŸ”Œ Test de connexion"
    databricks workspace ls /
  displayName: 'ðŸ” Configurer Databricks CLI'

# =============================================
# 3. VÃ©rifier structure du projet
# =============================================
- script: |
    echo "ðŸ“‚ Structure du projet :"
    ls -la

    echo ""
    echo "ðŸ“ Contenu de notebooks/ :"
    if [ -d "notebooks" ]; then
      ls -la notebooks/
      file_count=$(find notebooks -type f \( -name "*.py" -o -name "*.ipynb" \) | wc -l)
      echo ""
      echo "ðŸ“Š Nombre de notebooks trouvÃ©s : $file_count"
      if [ $file_count -eq 0 ]; then
        echo "âš ï¸ Aucun notebook trouvÃ© dans notebooks/"
        exit 1
      fi
    else
      echo "âŒ Dossier notebooks/ inexistant"
      exit 1
    fi
  displayName: 'ðŸ” VÃ©rifier structure du projet'

# =============================================
# 4. DÃ©ployer les notebooks
# =============================================
- script: |
    echo "ðŸ“¤ DÃ©ploiement des notebooks..."
    databricks workspace mkdirs $(DATABRICKS_WORKSPACE_PATH)
    databricks workspace import_dir notebooks $(DATABRICKS_WORKSPACE_PATH) --overwrite
  displayName: 'ðŸ“¤ DÃ©ployer notebooks Databricks'

# =============================================
# 5. Lancer le job Databricks (corrigÃ©)
# =============================================
- script: |
    echo "ðŸš€ Lancement du job Databricks..."
    echo "ðŸŽ¯ Job ID : $(DATABRICKS_JOB_ID)"

    # Lancer le job
    response=$(databricks jobs run-now --job-id $(DATABRICKS_JOB_ID))

    echo "ðŸ“¨ RÃ©ponse brute :"
    echo "$response"

    # EXTRAIRE le JSON complet
    json_block=$(echo "$response" | sed -n '/{/,/}/p')

    echo "ðŸ“¦ JSON extrait :"
    echo "$json_block"

    # Extraire run_id
    run_id=$(echo "$json_block" | jq -r '.run_id')

    if [[ -z "$run_id" || "$run_id" == "null" ]]; then
      echo "âŒ Impossible dâ€™extraire run_id"
      echo "ðŸ“Œ JSON reÃ§u : $json_block"
      exit 1
    fi

    echo "âœ… Job lancÃ© ! Run ID : $run_id"

    # Stocker run_id pour lâ€™Ã©tape suivante
    echo "##vso[task.setvariable variable=RUN_ID]$run_id"
  displayName: 'ðŸš€ Lancer job Databricks'

# =============================================
# 6. Attendre la fin et vÃ©rifier le rÃ©sultat
# =============================================
- script: |
    echo "â³ Attente de la fin du job..."
    echo "â–¶ï¸ Run ID : $(RUN_ID)"

    # Timeout 30 min
    timeout 1800 databricks runs wait --run-id $(RUN_ID)
    wait_exit=$?

    if [ $wait_exit -eq 0 ]; then
      details=$(databricks runs get --run-id $(RUN_ID))
      result=$(echo "$details" | jq -r '.state.result_state')
      echo "ðŸ“Š Resultat : $result"

      if [ "$result" != "SUCCESS" ]; then
        echo "âŒ JOB Ã‰CHOUÃ‰"
        databricks runs get-output --run-id $(RUN_ID)
        exit 1
      fi
      echo "ðŸŽ‰ JOB TERMINÃ‰ AVEC SUCCÃˆS"
    elif [ $wait_exit -eq 124 ]; then
      echo "â±ï¸ TIMEOUT (30min) : vÃ©rifier manuellement"
      exit 1
    else
      echo "âŒ Erreur inattendue pendant lâ€™attente du job"
      exit 1
    fi
  displayName: 'â³ Attendre et vÃ©rifier rÃ©sultat'

# =============================================
# 7. RÃ©capitulatif final
# =============================================
- script: |
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   ðŸ“Š FIN DU PIPELINE â€“ TOUT EST OK"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "Job ID : $(DATABRICKS_JOB_ID)"
    echo "Run ID : $(RUN_ID)"
    echo "Workspace : $(DATABRICKS_WORKSPACE_PATH)"
    echo "Lien Job : $(DATABRICKS_HOST)/#job/$(DATABRICKS_JOB_ID)/run/$(RUN_ID)"
    echo "Lien Workspace : $(DATABRICKS_HOST)/#workspace$(DATABRICKS_WORKSPACE_PATH)"
    echo "Date : $(date '+%Y-%m-%d %H:%M:%S')"
    echo "Build : $(Build.BuildNumber)"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  displayName: 'ðŸ“Š RÃ©capitulatif final'
  condition: always()
